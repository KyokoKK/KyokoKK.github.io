<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食事管理（MVP）</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/icons/icon-192.png">
  <style>
    :root { color-scheme: light dark }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP"; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .nav { display:flex; gap:8px; margin-bottom:12px; position:sticky; top:0; background:#0f172a; padding-top:10px }
    .tab { flex:1; text-align:center; padding:10px 0; border-radius:12px; background:#111827; border:1px solid #1f2937; cursor:pointer; user-select:none }
    .tab.active { background:#0ea5e9; color:#0b1220; font-weight:700 }
    .card { background:#111827; border:1px solid #1f2937; border-radius:16px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,.2); margin-bottom:12px }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grow { flex:1 }
    input, select { background:#0b1220; color:#e2e8f0; border:1px solid #1f2937; border-radius:10px; padding:8px; width:100% }
    button { background:#0ea5e9; color:#0b1220; border:1px solid #334155; border-radius:12px; padding:8px 12px; font-weight:700; cursor:pointer }
    table { width:100%; border-collapse:collapse; font-size:14px }
    th, td { padding:6px 4px; border-bottom:1px solid #1f2937; text-align:right }
    th:first-child, td:first-child { text-align:left }
    small.muted{ color:#94a3b8 }
    .pill { padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; }
    .fav { color:#fbbf24; cursor:pointer }
  </style>
</head>
<body>
  <div class="wrap">
  <div class="nav" id="tabs">
  <div class="tab active" data-tab="log">食事ログ</div>
  <div class="tab" data-tab="foods">食品DB</div>
  <div class="tab" data-tab="settings">設定</div>
</div>


    <section id="log" class="tabpane">
      <div class="card">
        <div class="row">
          <input id="date" type="date" class="grow">
          <span class="pill">目標: <span id="goalText">--</span></span>
          <span class="pill">合計: <span id="sumText">--</span></span>
        </div>
      </div>
      <div class="card">
        <div class="row">
          <select id="foodSelect" class="grow"></select>
          <input id="grams" type="number" placeholder="グラム(g)" style="width:120px">
          <button id="addBtn">追加</button>
        </div>
        <small class="muted">※ すべて <b>100g基準</b>、入力はグラム(g)。</small>
      </div>
      <div class="card">
        <table id="logTable">
          <thead><tr><th>食品</th><th>量(g)</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card"><b>今日のひとこと</b><div id="tip">--</div></div>
    </section>

    <section id="foods" class="tabpane" style="display:none">
      <div class="card">
        <div class="row">
          <input id="q" placeholder="検索（例: 鶏胸, 卵, 米）" class="grow">
          <button id="clearFav">よく使う★を消す</button>
        </div>
      </div>
      <div id="foodsList"></div>
    </section>

    <section id="settings" class="tabpane" style="display:none">
      <div class="card">
        <div class="row">
          <div class="grow">体重(kg)<br><input id="w" type="number" placeholder="60"></div>
          <div class="grow">身長(cm)<br><input id="h" type="number" placeholder="165"></div>
          <div class="grow">年齢<br><input id="age" type="number" placeholder="30"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="grow">性別<br><select id="sex"><option value="f">女性</option><option value="m">男性</option></select></div>
          <div class="grow">
            活動量<br>
            <select id="act">
              <option value="1.2">低い</option>
              <option value="1.375">やや低い</option>
              <option value="1.55">普通</option>
              <option value="1.725">高い</option>
              <option value="1.9">とても高い</option>
            </select>
          </div>
          <div class="grow">
            目標<br>
            <select id="goal">
              <option value="-300">減量（-300kcal/日）</option>
              <option value="0" selected>維持</option>
              <option value="300">増量（+300kcal/日）</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="saveSettings">保存</button>
          <small class="muted">保存すると目標PFCが自動計算されます。</small>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill">目標: <span id="goalCalc">--</span></span>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---- PWA boot
    <script>
// === Tabs 最終兵器（クリック/タップ/ハッシュ対応、既存コードに依存しない）===
(function(){
  const tabsEl = document.getElementById('tabs');
  if (!tabsEl) return;

  function showTab(tab){
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    const cur = tabsEl.querySelector(`.tab[data-tab="${tab}"]`);
    if (cur) cur.classList.add('active');
    document.querySelectorAll('.tabpane').forEach(p=>p.style.display = (p.id===tab?'':'none'));
    if (typeof renderFoodsList === 'function' && tab==='foods') renderFoodsList();
  }

  // クリック
  tabsEl.addEventListener('click', e=>{
    const t = e.target.closest('.tab');
    if (t) showTab(t.dataset.tab);
  }, {passive:true});

  // タッチ（端末で click を拾わない事故対策）
  tabsEl.addEventListener('touchend', e=>{
    const t = e.target.closest('.tab');
    if (t) { e.preventDefault(); showTab(t.dataset.tab); }
  }, {passive:false});

  // URLで #foods を指定されたら強制で切替
  const h = location.hash.replace('#','');
  if (h) showTab(h);
})();
</script>

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js?v=8').catch(console.error));
    }

    // ---- Data (sample foods per 100g)
    const foodDb = [
      {id:'apple', name:'りんご', cat:'果物', kcal:52, p:0.3, f:0.2, c:14},
      {id:'bread', name:'食パン', cat:'穀類', kcal:264, p:9, f:4.2, c:46},
      {id:'chicken', name:'鶏むね(皮なし)', cat:'肉類', kcal:108, p:23, f:1.5, c:0},
      {id:'egg', name:'卵', cat:'卵類', kcal:151, p:12.3, f:10.3, c:0.4},
      {id:'rice', name:'ごはん(白米)', cat:'穀類',
