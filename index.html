<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食事管理（MVP）</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/icons/icon-192.png">
  <style>
    :root { color-scheme: light dark }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP"; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .nav { display:flex; gap:8px; margin-bottom:12px; position:sticky; top:0; background:#0f172a; padding-top:10px }
    .tab { flex:1; text-align:center; padding:10px 0; border-radius:12px; background:#111827; border:1px solid #1f2937; cursor:pointer; user-select:none }
    .tab.active { background:#0ea5e9; color:#0b1220; font-weight:700 }
    .card { background:#111827; border:1px solid #1f2937; border-radius:16px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,.2); margin-bottom:12px }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grow { flex:1 }
    input, select { background:#0b1220; color:#e2e8f0; border:1px solid #1f2937; border-radius:10px; padding:8px; width:100% }
    button { background:#0ea5e9; color:#0b1220; border:1px solid #334155; border-radius:12px; padding:8px 12px; font-weight:700; cursor:pointer }
    table { width:100%; border-collapse:collapse; font-size:14px }
    th, td { padding:6px 4px; border-bottom:1px solid #1f2937; text-align:right }
    th:first-child, td:first-child { text-align:left }
    small.muted{ color:#94a3b8 }
    .pill { padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; }
    .fav { color:#fbbf24; cursor:pointer }
  </style>
</head>
<body>
  <div class="wrap">
  <div class="nav" id="tabs">
  <div class="tab active" data-tab="log">食事ログ</div>
  <div class="tab" data-tab="foods">食品DB</div>
  <div class="tab" data-tab="settings">設定</div>
</div>
<section id="log" class="tabpane">
  <div class="card">
    <div class="row">
      <input id="date" type="date" class="grow">
      <span class="pill">目標: <span id="goalText">--</span></span>
      <span class="pill">合計: <span id="sumText">--</span></span>
    </div>
  </div>
  <div class="card">
    <!-- 予備：CSVを貼り付けて取り込み -->
  <details>
    <summary>CSVを貼り付けて取り込む（うまく選べない時の予備）</summary>
    <textarea id="csvText" rows="6" class="grow" placeholder="ここにCSVを貼り付け"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="csvTextImport">貼り付けを取り込む</button>
      <button id="csvTextSample">サンプルを入れる</button>
    </div>
  </details>
</div>

    <div class="row">
      <select id="foodSelect" class="grow"></select>
      <input id="grams" type="number" placeholder="グラム(g)" style="width:120px">
      <button id="addBtn">追加</button>
    </div>
    <small class="muted">※ すべて <b>100g基準</b>、入力はグラム(g)。</small>
  </div>
  <div class="card">
    <table id="logTable">
      <thead><tr><th>食品</th><th>量(g)</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card"><b>今日のひとこと</b><div id="tip">--</div></div>
</section>

<section id="foods" class="tabpane" style="display:none">
  <div class="card">
    <div class="row">
      <input id="q" placeholder="検索（例: 鶏胸, 卵, 米）" class="grow">
      <button id="clearFav">よく使う★を消す</button>
    </div>
  </div>
  <div class="card">
    <div class="row">
      <input type="file" id="csvFile" accept=".csv,text/csv" class="grow">
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="csvNormalize"> このCSVは1食(1個)あたり → 100gに換算
      </label>
    </div>
    <small class="muted">
      使える列名の例：食品名/分類/エネルギー(kcal)/たんぱく質/脂質/炭水化物/重量(g)。<br>
      欠損行はスキップ。取り込むと検索や★ピンに反映されます。
    </small>
    <div id="importInfo" class="muted" style="margin-top:8px"></div>
  </div>
  <div id="foodsList"></div>
</section>
    <section id="settings" class="tabpane" style="display:none">
  <div class="card">
    <div class="row">
      <div class="grow">体重(kg)<br><input id="w" type="number" placeholder="60"></div>
      <div class="grow">身長(cm)<br><input id="h" type="number" placeholder="165"></div>
      <div class="grow">年齢<br><input id="age" type="number" placeholder="30"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="grow">性別<br>
        <select id="sex"><option value="f">女性</option><option value="m">男性</option></select>
      </div>
      <div class="grow">活動量<br>
        <select id="act">
          <option value="1.2">低い</option>
          <option value="1.375">やや低い</option>
          <option value="1.55">普通</option>
          <option value="1.725">高い</option>
          <option value="1.9">とても高い</option>
        </select>
      </div>
      <div class="grow">目標<br>
        <select id="goal">
          <option value="-300">減量（-300kcal/日）</option>
          <option value="0" selected>維持</option>
          <option value="300">増量（+300kcal/日）</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="saveSettings">保存</button>
      <small class="muted">保存すると目標PFCが自動計算されます。</small>
    </div>
    <div class="row" style="margin-top:10px">
      <span class="pill">目標: <span id="goalCalc">--</span></span>
    </div>
  </div>
</section>






    <section id="log" class="tabpane">
      <div class="card">
        <div class="row">
          <input id="date" type="date" class="grow">
          <span class="pill">目標: <span id="goalText">--</span></span>
          <span class="pill">合計: <span id="sumText">--</span></span>
        </div>
      </div>
      <div class="card">
        <div class="row">
          <select id="foodSelect" class="grow"></select>
          <input id="grams" type="number" placeholder="グラム(g)" style="width:120px">
          <button id="addBtn">追加</button>
        </div>
        <small class="muted">※ すべて <b>100g基準</b>、入力はグラム(g)。</small>
      </div>
      <div class="card">
        <table id="logTable">
          <thead><tr><th>食品</th><th>量(g)</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card"><b>今日のひとこと</b><div id="tip">--</div></div>
    </section>

    <section id="foods" class="tabpane" style="display:none">
      <div class="card">
        <div class="row">
          <input id="q" placeholder="検索（例: 鶏胸, 卵, 米）" class="grow">
          <button id="clearFav">よく使う★を消す</button>
        </div>
      </div>
      <div id="foodsList"></div>
    </section>

   
  </div>

<script>
// ---- PWA boot (cache bust)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () =>
    navigator.serviceWorker.register('/sw.js?v=12').catch(console.error)
  );
}

// ---- Data (100gあたりのサンプル)
const foodDb = [
  {id:'apple', name:'りんご', cat:'果物', kcal:52, p:0.3, f:0.2, c:14},
  {id:'bread', name:'食パン', cat:'穀類', kcal:264, p:9, f:4.2, c:46},
  {id:'chicken', name:'鶏むね(皮なし)', cat:'肉類', kcal:108, p:23, f:1.5, c:0},
  {id:'egg', name:'卵', cat:'卵類', kcal:151, p:12.3, f:10.3, c:0.4},
  {id:'rice', name:'ごはん(白米)', cat:'穀類', kcal:168, p:2.5, f:0.3, c:37},
  {id:'tofu', name:'木綿豆腐', cat:'大豆', kcal:72, p:6.6, f:4.2, c:1.2},
  {id:'yogurt', name:'ヨーグルト(無糖)', cat:'乳製品', kcal:62, p:3.6, f:3.3, c:4.7},
  {id:'salmon', name:'サーモン(生)', cat:'魚介', kcal:133, p:20.1, f:4.5, c:0},
  {id:'banana', name:'バナナ', cat:'果物', kcal:93, p:1.1, f:0.2, c:23},
  {id:'olive', name:'オリーブオイル', cat:'油脂', kcal:921, p:0, f:100, c:0}
];// 追加: ユーザー取り込み食品
let userFoods = JSON.parse(localStorage.getItem('userFoods')||'[]');
const allFoods = () => [...foodDb, ...userFoods];


// ---- Utils & state
const $ = (s, el=document)=>el.querySelector(s);
const $$ = (s, el=document)=>[...el.querySelectorAll(s)];
const pad = n => String(n).padStart(2,'0');
const yyyyMmDd = (d=new Date()) => [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');

const state = {
  date: yyyyMmDd(new Date()),
  entries: JSON.parse(localStorage.getItem('entriesByDate')||'{}'),
  favs: JSON.parse(localStorage.getItem('favFoods')||'[]'),
  settings: JSON.parse(localStorage.getItem('settings')||'{}')
};

// ---- Tabs（クリック/タップ/ハッシュ対応・委譲）
const tabsEl = document.getElementById('tabs');
function showTab(tab){
  $$('.tab').forEach(x=>x.classList.remove('active'));
  const cur = $(`.tab[data-tab="${tab}"]`, tabsEl);
  if (cur) cur.classList.add('active');
  $$('.tabpane').forEach(p=>p.style.display = (p.id===tab?'':'none'));
  if (tab==='foods') renderFoodsList();
}
tabsEl.addEventListener('click', e=>{
  const t = e.target.closest('.tab'); if (t) showTab(t.dataset.tab);
}, {passive:true});
tabsEl.addEventListener('touchend', e=>{
  const t = e.target.closest('.tab'); if (t) { e.preventDefault(); showTab(t.dataset.tab); }
}, {passive:false});
window.addEventListener('hashchange', ()=>{
  const h = location.hash.replace('#',''); if (h) showTab(h);
});

// ---- 食品DBレンダリング
function renderFoodOptions(){
  const favFirst = [allfoodDb].sort((a,b)=>
    (state.favs.includes(b.id)-state.favs.includes(a.id)) || a.name.localeCompare(b.name,'ja')
  );
  $('#foodSelect').innerHTML = favFirst.map(f=>`<option value="${f.id}">${state.favs.includes(f.id)?'★ ':''}${f.name}</option>`).join('');
}
function renderFoodsList(){
  const q = ($('#q')?.value||'').toLowerCase();
// 変更前: const data = foodDb.filter( ...
const data = allFoods().filter(f => (f.name||'').toLowerCase().includes(q) || (f.cat||'').toLowerCase().includes(q));
  const wrap = document.createElement('div');
  data.forEach(f=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `
      <div class="row">
        <div class="grow"><b>${f.name}</b> <small class="muted">(${f.cat})</small><br>
          <small class="muted">100gあたり: ${f.kcal}kcal / P${f.p} F${f.f} C${f.c}</small>
        </div>
        <div class="fav" data-id="${f.id}">${state.favs.includes(f.id)?'★':'☆'}</div>
      </div>`;
    div.querySelector('.fav').onclick = (e)=>{
      const id = e.target.dataset.id;
      if (state.favs.includes(id)) state.favs = state.favs.filter(x=>x!==id);
      else state.favs.push(id);
      localStorage.setItem('favFoods', JSON.stringify(state.favs));
      renderFoodOptions(); renderFoodsList();
    };
    wrap.appendChild(div);
  });
  const container = $('#foodsList'); if (container){ container.innerHTML=''; container.appendChild(wrap); }
}

// ---- 入力・計算まわり
$('#q')?.addEventListener('input', renderFoodsList);
$('#clearFav')?.addEventListener('click', ()=>{
  state.favs=[]; localStorage.setItem('favFoods','[]'); renderFoodOptions(); renderFoodsList();
});

$('#addBtn')?.addEventListener('click', ()=>{
 // 変更前: const food = foodDb.find(f => f.id === $('#foodSelect').value);
const food = allFoods().find(f => f.id === $('#foodSelect').value);
  const g = Number($('#grams').value||0);
  if (!food || g<=0) { alert('食品とグラムを入力してね'); return; }
  const r = g/100;
  const e = { id:crypto.randomUUID(), foodId:food.id, name:food.name, g,
    kcal: food.kcal*r, p:food.p*r, f:food.f*r, c:food.c*r };
  const key = state.date;
  state.entries[key] = (state.entries[key]||[]).concat(e);
  localStorage.setItem('entriesByDate', JSON.stringify(state.entries));
  $('#grams').value = ''; renderLog();
});

$('#date')?.addEventListener('change', ()=>{
  state.date = $('#date').value; renderLog();
});

// ---- 目標計算
function bmr(s){
  const w=+s.w||60, h=+s.h||165, age=+s.age||30;
  return (s.sex||'f')==='m' ? 10*w + 6.25*h - 5*age + 5 : 10*w + 6.25*h - 5*age - 161;
}
function recom(s){
  const tdee = bmr(s) * (+s.act||1.55) + (+s.goal||0);
  const p = 2.0*(+s.w||60), f = 0.8*(+s.w||60);
  const c = Math.max(0, (tdee - (p*4 + f*9))/4);
  return {tdee,p,f,c};
}
$('#saveSettings')?.addEventListener('click', ()=>{
  state.settings = { w:$('#w').value, h:$('#h').value, age:$('#age').value,
    sex:$('#sex').value, act:$('#act').value, goal:$('#goal').value };
  localStorage.setItem('settings', JSON.stringify(state.settings));
  updateGoalBadge(); alert('保存しました');
});
function updateGoalBadge(){
  const s = state.settings||{};
  if (!s.w) { $('#goalText').textContent='--'; return; }
  const r = recom(s);
  const txt = `${Math.round(r.tdee)}kcal / P${r.p.toFixed(0)} F${r.f.toFixed(0)} C${r.c.toFixed(0)}`;
  $('#goalText').textContent = txt; $('#goalCalc').textContent = txt;
}

// ---- 表描画
function renderLog(){
  const rows = state.entries[state.date] || [];
  const sum = (k)=>rows.reduce((a,x)=>a+(+x[k]||0),0);
  const tbody = $('#logTable tbody'); if (!tbody) return;
  tbody.innerHTML = rows.map(r =>
    `<tr><td>${r.name}</td><td>${r.g}</td><td>${Math.round(r.kcal)}</td><td>${(r.p).toFixed(1)}</td><td>${(r.f).toFixed(1)}</td><td>${Math.round(r.c)}</td><td><button data-id="${r.id}" class="del">削除</button></td></tr>`
  ).join('');
  $$('.del', tbody).forEach(btn => btn.onclick = ()=>{
    const id = btn.dataset.id;
    state.entries[state.date] = (state.entries[state.date]||[]).filter(x=>x.id!==id);
    localStorage.setItem('entriesByDate', JSON.stringify(state.entries));
    renderLog();
  });
  const tot = {kcal:sum('kcal'), p:sum('p'), f:sum('f'), c:sum('c')};
  $('#sumText').textContent = `${Math.round(tot.kcal)}kcal / P${tot.p.toFixed(1)} F${tot.f.toFixed(1)} C${Math.round(tot.c)}`;
  $('#tip').textContent = (tot.f>60) ? '今日は脂質控えめでバランス調整を。'
                     : (tot.p<60) ? 'タンパク質をもう一品プラス。'
                     : 'いいペース！水分補給も忘れずに。';
  updateGoalBadge();
}

// ---- init
(function init(){
  const s = state.settings||{};
  if ($('#w')) { $('#w').value = s.w||''; $('#h').value = s.h||''; $('#age').value = s.age||''; }
  if ($('#sex')) { $('#sex').value = s.sex||'f'; $('#act').value = s.act||'1.55'; $('#goal').value = s.goal||'0'; }
  if ($('#date')) $('#date').value = state.date;
  renderFoodOptions(); renderFoodsList(); renderLog();
  const h = location.hash.replace('#',''); if (h) showTab(h);
})();// ---- CSV import (ゆるめ) ----------------------------------------------------

// 軽量CSVパーサ（クォート/改行対応）
function parseCSV(text){
  text = String(text||'').replace(/^\uFEFF/, ''); // BOM除去
  const out = []; let row = [], field = '', i = 0, q = false;
  while (i < text.length){
    const c = text[i];
    if (q){
      if (c === '"' && text[i+1] === '"'){ field += '"'; i+=2; continue; }
      if (c === '"'){ q = false; i++; continue; }
      field += c; i++; continue;
    } else {
      if (c === '"'){ q = true; i++; continue; }
      if (c === ','){ row.push(field); field=''; i++; continue; }
      if (c === '\n'){ row.push(field); out.push(row); row=[]; field=''; i++; continue; }
      if (c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); out.push(row);
  // 末尾の空行除去
  return out.filter(r => r.some(x => String(x).trim() !== ''));
}

// ヘッダ正規化
function normHeader(s){
  return String(s||'').toLowerCase()
    .replace(/\s+/g,'')
    .replace(/[［\[\(（\)）\]］]/g,'')
    .replace(/ー/g,'-')
    .replace(/[\.．]/g,'.');
}

// 列の自動検出
function detectColumns(head){
  const h = head.map(normHeader);
  const find = (alts)=> h.findIndex(x => alts.some(a => x.includes(a)));
  return {
    name: find(['食品名','食品','名称','品目','料理名']),
    cat:  find(['分類','大分類','中分類','カテゴリ']),
    kcal: find(['エネルギーkcal','エネルギー.kcal','エネルギー','kcal','熱量']),
    p:    find(['たんぱく質','ﾀﾝﾊﾟｸ質','蛋白質','たんぱく質g']),
    f:    find(['脂質','脂肪','脂質g']),
    c:    find(['炭水化物','糖質','炭水化物g']),
    w:    find(['重量g','標準重量','重量','可食部重量','g'])
  };
}

// 数値に変換（数字以外は除去）
const toNum = (v) => {
  const n = parseFloat(String(v).replace(/[^0-9\.\-]/g,''));
  return Number.isFinite(n) ? n : NaN;
};

// 100g換算
function toPer100(v, weight, normalize){
  if (!normalize) return v;
  const w = toNum(weight);
  if (!Number.isFinite(w) || w === 0) return NaN;
  return v * (100 / w);
}

// CSV取り込み本体
async function importCsvFile(file, normalize){
  const text = await file.text();
  const rows = parseCSV(text);
  if (!rows.length) { $('#importInfo').textContent = 'CSVが空でした。'; return; }

  const head = rows[0];
  const col = detectColumns(head);

  const need = ['name','kcal','p','f','c'];
  const missing = need.filter(k => col[k] === -1);
  if (missing.length){
    $('#importInfo').textContent = '必須列が見つかりませんでした（最低: 食品名, エネルギー, たんぱく質, 脂質, 炭水化物）。';
    return;
  }

  let added=0, skipped=0;
  const list = [];

  for (const r of rows.slice(1)){
    const name = (r[col.name]||'').toString().trim();
    if (!name) { skipped++; continue; }

    const kcal = toPer100(toNum(r[col.kcal]), r[col.w], normalize);
    const p = toPer100(toNum(r[col.p]), r[col.w], normalize);
    const f = toPer100(toNum(r[col.f]), r[col.w], normalize);
    const c = toPer100(toNum(r[col.c]), r[col.w], normalize);
    if (![kcal,p,f,c].every(Number.isFinite)) { skipped++; continue; }

    const cat = col.cat>-1 ? (r[col.cat]||'').toString().trim() : 'CSV';
    list.push({ id:'u-'+crypto.randomUUID().slice(0,8), name, cat,
                kcal: Math.round(kcal), p:+p.toFixed(1), f:+f.toFixed(1), c: Math.round(c) });
  }

  // 既存 userFoods とマージ（同名は上書き）
  const map = new Map(userFoods.map(x => [x.name, x]));
  list.forEach(x => map.set(x.name, x));
  userFoods = Array.from(map.values());
  localStorage.setItem('userFoods', JSON.stringify(userFoods));
  added = list.length; // スキップは既に計上済み

  // 画面更新
  renderFoodOptions(); renderFoodsList();
  $('#importInfo').textContent = `取り込み完了: ${added}件 / スキップ: ${skipped}件`;
}

// イベントバインド
function importCsvText(text, normalize){
  const rows = parseCSV(text);
  if (!rows.length){ document.querySelector('#importInfo').textContent = 'CSVが空でした。'; return; }

  const head = rows[0];
  const col = detectColumns(head);
  const need = ['name','kcal','p','f','c'];
  const missing = need.filter(k => col[k] === -1);
  if (missing.length){
    document.querySelector('#importInfo').textContent = '必須列が見つかりません（食品名/エネルギー/たんぱく質/脂質/炭水化物）。';
    return;
  }

  let added=0, skipped=0;
  const map = new Map(userFoods.map(x => [x.name, x]));

  for (const r of rows.slice(1)){
    const name = (r[col.name]||'').toString().trim();
    if (!name){ skipped++; continue; }
    const kcal = toPer100(toNum(r[col.kcal]), r[col.w], normalize);
    const p = toPer100(toNum(r[col.p]), r[col.w], normalize);
    const f = toPer100(toNum(r[col.f]), r[col.w], normalize);
    const c = toPer100(toNum(r[col.c]), r[col.w], normalize);
    if (![kcal,p,f,c].every(Number.isFinite)){ skipped++; continue; }
    const cat = col.cat>-1 ? (r[col.cat]||'').toString().trim() : 'CSV';
    map.set(name, { id:'u-'+crypto.randomUUID().slice(0,8), name, cat,
                    kcal: Math.round(kcal), p:+p.toFixed(1), f:+f.toFixed(1), c: Math.round(c) });
    added++;
  }

  userFoods = Array.from(map.values());
  localStorage.setItem('userFoods', JSON.stringify(userFoods));
  renderFoodOptions(); renderFoodsList();
  document.querySelector('#importInfo').textContent = `取り込み完了: ${added}件 / スキップ: ${skipped}件`;
}

(function bindCsvText(){
  const $ = s => document.querySelector(s);
  const btn = $('#csvTextImport');
  if (!btn) return;

  $('#csvTextSample')?.addEventListener('click', ()=>{
    $('#csvText').value =
`食品名,分類,エネルギー(kcal),たんぱく質,脂質,炭水化物
オートミール,穀類,380,13.7,5.7,69.1
ささみ,肉類,105,23.9,0.8,0
ブロッコリー,野菜,33,4.3,0.5,5.2`;
  });

  btn.addEventListener('click', ()=>{
    const t = ($('#csvText').value||'').trim();
    if (!t){ $('#importInfo').textContent = 'テキストが空です。'; return; }
    $('#importInfo').textContent = '取り込み中…';
    try {
      importCsvText(t, !!document.getElementById('csvNormalize')?.checked);
    } catch(e){
      console.error(e);
      $('#importInfo').textContent = '取り込みでエラーが発生しました。';
    }
  });
})();

</script>
</body>
</html>


